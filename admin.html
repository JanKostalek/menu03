<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Admin - Restaurace</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .topbar{
      display:flex;
      justify-content: space-between;
      align-items:flex-start;
      gap: 10px;
      margin: 10px 0 15px 0;
    }
    .rightTop{
      display:flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 6px;
      min-width: 260px;
    }
    .recache-status{
      font-size: 12px;
      color: #0b7a0b;
      min-height: 16px;
      text-align: right;
    }

    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .row input, .row select { flex: 1 1 320px; padding:10px; margin:6px 0; }

    .section { border:1px solid #ccc; padding:15px; margin-top:20px; background:#fff; border-radius:8px; }

    .list-item { display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .list-left { min-width: 0; flex: 1 1 auto; }
    .muted { color:#666; font-size: 12px; word-break: break-all; }

    .btn{
      padding: 8px 12px;
      border: 1px solid #bbb;
      background: #e6e6e6;
      cursor: pointer;
      border-radius: 6px;
      font-family: inherit;
    }
    .btn:hover{ background:#dcdcdc; }

    .danger { background:#b00020; color:white; border:none; padding:8px 10px; cursor:pointer; border-radius:6px; }
    .danger:hover { opacity:0.9; }

    .updateBtn{
      background:#2d6cdf;
      color:#fff;
      border:none;
      padding:8px 10px;
      cursor:pointer;
      border-radius:6px;
      margin-right: 8px;
    }
    .updateBtn:hover{ opacity:0.9; }

    .pill { display:inline-block; padding:3px 8px; border:1px solid #ccc; border-radius:999px; font-size:12px; background:#f3f3f3; }

    .modeBox{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:6px; }
    .modeBtn{
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid #bbb;
      background: #f3f3f3;
      cursor:pointer;
      font-size: 12px;
    }
    .modeBtn.active{
      background: #b9e4b9;
      border-color: #7ac77a;
    }

    .actionsRight{ display:flex; gap: 0px; align-items:center; }
    hr{ border:none; border-top:1px solid #ddd; margin: 12px 0; }
  </style>
</head>
<body>

<h2>Admin – Restaurace</h2>

<div class="topbar">
  <button class="btn" onclick="goBack()">← Zpět na menu</button>

  <div class="rightTop">
    <button class="btn" onclick="reCacheAll()">ReCache</button>
    <div id="recacheStatus" class="recache-status"></div>
  </div>
</div>

<div class="section">
  <h3>Přidat restauraci</h3>
  <div class="row">
    <input type="text" id="name" placeholder="Název restaurace" />
    <input type="text" id="url" placeholder="URL menu (HTML/PDF/obrázek)" />
    <select id="mode">
      <option value="parse" selected>Parsovat HTML (zkusit vyčíst jídla a ceny)</option>
      <option value="embed">Zobrazit zdroj (iframe/popup) – bez parsování</option>
    </select>
  </div>
  <div class="row">
    <button class="btn" onclick="addRestaurant()">Uložit</button>
    <span id="status" class="muted"></span>
  </div>
  <div class="muted">
    Tip: Pro weby se složitou strukturou (cookie/18+/dynamika) použij „Zobrazit zdroj“.
  </div>
</div>

<div class="section">
  <h3>Návrhy restaurací</h3>
  <div id="suggestions" class="muted">Načítám…</div>
</div>

<div class="section">
  <h3>Seznam restaurací</h3>
  <div id="list" class="muted">Načítám…</div>
</div>

<script>
const PASSWORD = "H3510";

const entered = prompt("Zadej heslo:");
if (entered !== PASSWORD) {
  alert("Špatné heslo");
  window.location.href = "/";
}

function goBack() {
  window.location.href = "/";
}

const statusEl = document.getElementById("status");
const listEl = document.getElementById("list");
const suggestionsEl = document.getElementById("suggestions");
const recacheStatusEl = document.getElementById("recacheStatus");

const LS_MENU_CACHE_TODAY = "menu03_menu_cache_today";
const LS_MENU_CACHE_ALL = "menu03_menu_cache_all";
const LS_MENU_CACHE_DATE_TODAY = "menu03_menu_cache_date_today";
const LS_MENU_CACHE_DATE_ALL = "menu03_menu_cache_date_all";
const LS_RESTAURANTS_SIG = "menu03_restaurants_sig";

const pendingModeById = new Map();

function setStatus(msg, isOk=false) {
  statusEl.textContent = msg || "";
  statusEl.className = "muted" + (isOk ? " ok" : "");
}

function setRecacheStatus(msg) {
  recacheStatusEl.textContent = msg || "";
}

async function fetchRestaurants() {
  const resp = await fetch("/api/restaurants", { cache: "no-store" });
  if (!resp.ok) throw new Error("GET /api/restaurants " + resp.status);
  return await resp.json();
}

async function fetchSuggestions() {
  const resp = await fetch("/api/suggestions", { cache: "no-store" });
  if (!resp.ok) throw new Error("GET /api/suggestions " + resp.status);
  return await resp.json();
}

function clearLocalCacheOnly() {
  try {
    localStorage.removeItem(LS_MENU_CACHE_TODAY);
    localStorage.removeItem(LS_MENU_CACHE_ALL);
    localStorage.removeItem(LS_MENU_CACHE_DATE_TODAY);
    localStorage.removeItem(LS_MENU_CACHE_DATE_ALL);
    localStorage.removeItem(LS_RESTAURANTS_SIG);
  } catch {}
}

function normalizeMode(m) {
  const v = String(m || "").toLowerCase();
  return (v === "embed" || v === "parse") ? v : "parse";
}

function renderRestaurants(restaurants) {
  if (!restaurants || restaurants.length === 0) {
    listEl.innerHTML = "<div class='muted'>Zatím žádné restaurace.</div>";
    return;
  }

  const html = restaurants.map(r => {
    const currentMode = normalizeMode(r.mode);
    const pending = pendingModeById.has(r.id) ? pendingModeById.get(r.id) : currentMode;

    const parseActive = pending === "parse" ? "active" : "";
    const embedActive = pending === "embed" ? "active" : "";

    return `
      <div class="list-item">
        <div class="list-left">
          <div>
            <b>${escapeHtml(r.name)}</b>
            <span class="pill">${escapeHtml(currentMode)}</span>
          </div>

          <div class="muted">${escapeHtml(r.url)}</div>

          <div class="modeBox">
            <span class="muted">Mode:</span>
            <button class="modeBtn ${parseActive}" onclick="pickMode('${escapeHtmlAttr(r.id)}','parse')">Parse</button>
            <button class="modeBtn ${embedActive}" onclick="pickMode('${escapeHtmlAttr(r.id)}','embed')">Embed</button>
            <span class="muted">→ pak klikni Update</span>
          </div>
        </div>

        <div class="actionsRight">
          <button class="updateBtn" onclick="updateRestaurantMode('${escapeHtmlAttr(r.id)}')">Update</button>
          <button class="danger" onclick="deleteRestaurant('${escapeHtmlAttr(r.id)}', '${escapeHtmlAttr(r.name)}')">Smazat</button>
        </div>
      </div>
      <hr>
    `;
  }).join("");

  listEl.innerHTML = html;
}

function renderSuggestions(items) {
  if (!items || items.length === 0) {
    suggestionsEl.innerHTML = "<div class='muted'>Zatím žádné návrhy.</div>";
    return;
  }

  const html = items.map(s => {
    const addr = s.menuUrl && s.menuUrl.trim() ? s.menuUrl.trim() : "neuvedeno";
    const who = (s.submitter && s.submitter.trim()) ? s.submitter.trim() : "neuvedeno";
    return `
      <div class="list-item">
        <div class="list-left">
          <div><b>${escapeHtml(s.name)}</b></div>
          <div class="muted">${escapeHtml(addr)}</div>
          <div class="muted">Jméno: ${escapeHtml(who)} | Email: ${escapeHtml(s.email)}</div>
        </div>
        <div>
          <button class="danger" onclick="deleteSuggestion('${escapeHtmlAttr(s.id)}', '${escapeHtmlAttr(s.name)}')">Smazat</button>
        </div>
      </div>
      <hr>
    `;
  }).join("");

  suggestionsEl.innerHTML = html;
}

async function loadRestaurants() {
  listEl.textContent = "Načítám…";
  try {
    const restaurants = await fetchRestaurants();

    const ids = new Set(restaurants.map(r => r.id));
    for (const k of Array.from(pendingModeById.keys())) {
      if (!ids.has(k)) pendingModeById.delete(k);
    }

    renderRestaurants(restaurants);
  } catch (e) {
    listEl.textContent = "Chyba: " + (e.message || e);
  }
}

async function loadSuggestions() {
  suggestionsEl.textContent = "Načítám…";
  try {
    const items = await fetchSuggestions();
    renderSuggestions(items);
  } catch (e) {
    suggestionsEl.textContent = "Chyba: " + (e.message || e);
  }
}

function pickMode(id, mode) {
  pendingModeById.set(id, normalizeMode(mode));
  loadRestaurants();
}

async function updateRestaurantMode(id) {
  const mode = pendingModeById.get(id);
  if (!mode) {
    alert("Nejprve vyber Parse nebo Embed.");
    return;
  }

  setStatus("Ukládám změnu…");

  // DŮLEŽITÉ: update děláme přes POST (kvůli “Method not allowed” na PUT)
  const resp = await fetch("/api/restaurants", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ action: "update", id, mode })
  });

  const data = await resp.json().catch(() => ({}));
  if (!resp.ok) {
    setStatus("Update selhal: " + (data.error || resp.status), false);
    return;
  }

  clearLocalCacheOnly();

  setStatus("Update hotový ✅ (cache invalidována)", true);

  pendingModeById.delete(id);
  await loadRestaurants();
}

async function addRestaurant() {
  const name = document.getElementById("name").value.trim();
  const url = document.getElementById("url").value.trim();
  const mode = document.getElementById("mode").value;

  if (!name || !url) {
    alert("Vyplň název i URL.");
    return;
  }

  setStatus("Ukládám…");
  const resp = await fetch("/api/restaurants", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, url, mode })
  });

  const data = await resp.json().catch(() => ({}));
  if (!resp.ok) {
    setStatus("Nepodařilo se uložit: " + (data.error || resp.status), false);
    return;
  }

  document.getElementById("name").value = "";
  document.getElementById("url").value = "";
  document.getElementById("mode").value = "parse";

  setStatus("Uloženo ✅ (cache invalidována automaticky)", true);

  clearLocalCacheOnly();
  await loadRestaurants();
}

async function deleteRestaurant(id, name) {
  if (!confirm("Opravdu smazat: " + name + "?")) return;
  setStatus("Mažu…");
  const resp = await fetch("/api/restaurants?id=" + encodeURIComponent(id), { method: "DELETE" });
  const data = await resp.json().catch(() => ({}));
  if (!resp.ok) {
    setStatus("Nepodařilo se smazat: " + (data.error || resp.status), false);
    return;
  }
  setStatus("Smazáno ✅ (cache invalidována automaticky)", true);

  pendingModeById.delete(id);
  clearLocalCacheOnly();
  await loadRestaurants();
}

async function deleteSuggestion(id, name) {
  if (!confirm("Smazat návrh: " + name + "?")) return;

  const resp = await fetch("/api/suggestions?id=" + encodeURIComponent(id), { method: "DELETE" });
  const data = await resp.json().catch(() => ({}));
  if (!resp.ok) {
    alert("Nepodařilo se smazat: " + (data.error || resp.status));
    return;
  }

  await loadSuggestions();
}

async function reCacheAll() {
  if (!confirm("ReCache: vyčistit lokální cache a vynutit nové cachování na serveru?")) return;

  setRecacheStatus("Provádím ReCache…");

  clearLocalCacheOnly();

  const resp = await fetch("/api/recache", { method: "POST" });
  const data = await resp.json().catch(() => ({}));

  if (!resp.ok) {
    setRecacheStatus("ReCache selhal: " + (data.error || resp.status));
    return;
  }

  setRecacheStatus("ReCache hotovo ✅ (teď jdi zpět na hlavní stránku)");
}

function escapeHtml(str) {
  return String(str || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}
function escapeHtmlAttr(str) { return escapeHtml(str); }

loadRestaurants();
loadSuggestions();
</script>

</body>
</html>