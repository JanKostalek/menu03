<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Admin - Restaurace</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .topbar {
      display:flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0 15px 0;
      gap: 10px;
    }

    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .row input, .row select { flex: 1 1 320px; padding:10px; margin:6px 0; }

    .list-item { display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .list-left { min-width: 0; }
    .muted { color:#666; font-size: 12px; word-break: break-all; }

    .danger { background:#b00020; color:white; border:none; padding:8px 10px; cursor:pointer; }
    .danger:hover { opacity:0.9; }

    .btn {
      padding: 8px 12px;
      border: 1px solid #bbb;
      background: #e6e6e6;
      cursor: pointer;
      border-radius: 6px;
    }
    .btn:hover { background:#dcdcdc; }

    .btn-recache {
      font-weight: 700;
    }

    .ok { color: #0b7a0b; }
    .section { border:1px solid #ccc; padding:15px; margin-top:20px; background:#fff; border-radius:8px; }
    .kv { word-break: break-word; }
    .pill { display:inline-block; padding:3px 8px; border:1px solid #ccc; border-radius:999px; font-size:12px; background:#f3f3f3; }
  </style>
</head>
<body>

<h2>Admin – Restaurace</h2>

<div class="topbar">
  <button class="btn" onclick="goBack()">← Zpět na menu</button>

  <button class="btn btn-recache" onclick="reCacheAll()">ReCache</button>
</div>

<div class="section">
  <h3>Přidat restauraci</h3>
  <div class="row">
    <input type="text" id="name" placeholder="Název restaurace" />
    <input type="text" id="url" placeholder="URL menu (HTML/PDF/obrázek)" />
    <select id="mode">
      <option value="parse" selected>Parsovat HTML (zkusit vyčíst jídla a ceny)</option>
      <option value="embed">Zobrazit zdroj (iframe/popup) – bez parsování</option>
    </select>
  </div>
  <div class="row">
    <button class="btn" onclick="addRestaurant()">Uložit</button>
    <span id="status" class="muted"></span>
  </div>
  <div class="muted">
    Tip: Pro weby se složitou strukturou (cookie/18+/dynamika) použij „Zobrazit zdroj“.
  </div>
</div>

<div class="section">
  <h3>Návrhy restaurací</h3>
  <div id="suggestions" class="muted">Načítám…</div>
</div>

<div class="section">
  <h3>Seznam restaurací</h3>
  <div id="list" class="muted">Načítám…</div>
</div>

<script>
const PASSWORD = "H3510";

const entered = prompt("Zadej heslo:");
if (entered !== PASSWORD) {
  alert("Špatné heslo");
  window.location.href = "/";
}

function goBack() {
  window.location.href = "/";
}

const statusEl = document.getElementById("status");
const listEl = document.getElementById("list");
const suggestionsEl = document.getElementById("suggestions");

// stejné klíče jako v script.js (hlavní stránka)
const LS_MENU_CACHE_TODAY = "menu03_menu_cache_today";
const LS_MENU_CACHE_ALL = "menu03_menu_cache_all";
const LS_MENU_CACHE_DATE_TODAY = "menu03_menu_cache_date_today";
const LS_MENU_CACHE_DATE_ALL = "menu03_menu_cache_date_all";
const LS_RESTAURANTS_SIG = "menu03_restaurants_sig";

function setStatus(msg, isOk=false) {
  statusEl.textContent = msg || "";
  statusEl.className = "muted" + (isOk ? " ok" : "");
}

async function fetchRestaurants() {
  const resp = await fetch("/api/restaurants", { cache: "no-store" });
  if (!resp.ok) throw new Error("GET /api/restaurants " + resp.status);
  return await resp.json();
}

async function fetchSuggestions() {
  const resp = await fetch("/api/suggestions", { cache: "no-store" });
  if (!resp.ok) throw new Error("GET /api/suggestions " + resp.status);
  return await resp.json();
}

function modeLabel(m) {
  const v = String(m || "").toLowerCase();
  if (v === "embed") return "embed";
  return "parse";
}

function renderRestaurants(restaurants) {
  if (!restaurants || restaurants.length === 0) {
    listEl.innerHTML = "<div class='muted'>Zatím žádné restaurace.</div>";
    return;
  }

  const html = restaurants.map(r => `
    <div class="list-item">
      <div class="list-left">
        <div>
          <b>${escapeHtml(r.name)}</b>
          <span class="pill">${escapeHtml(modeLabel(r.mode))}</span>
        </div>
        <div class="muted kv">${escapeHtml(r.url)}</div>
      </div>
      <div>
        <button class="danger" onclick="deleteRestaurant('${r.id}', '${escapeHtmlAttr(r.name)}')">Smazat</button>
      </div>
    </div>
    <hr>
  `).join("");

  listEl.innerHTML = html;
}

function renderSuggestions(items) {
  if (!items || items.length === 0) {
    suggestionsEl.innerHTML = "<div class='muted'>Zatím žádné návrhy.</div>";
    return;
  }

  const html = items.map(s => {
    const addr = s.menuUrl && s.menuUrl.trim() ? s.menuUrl.trim() : "neuvedeno";
    const who = (s.submitter && s.submitter.trim()) ? s.submitter.trim() : "neuvedeno";
    return `
      <div class="list-item">
        <div class="list-left">
          <div><b>${escapeHtml(s.name)}</b></div>
          <div class="muted kv">${escapeHtml(addr)}</div>
          <div class="muted">Jméno: ${escapeHtml(who)} | Email: ${escapeHtml(s.email)}</div>
        </div>
        <div>
          <button class="danger" onclick="deleteSuggestion('${s.id}', '${escapeHtmlAttr(s.name)}')">Smazat</button>
        </div>
      </div>
      <hr>
    `;
  }).join("");

  suggestionsEl.innerHTML = html;
}

async function loadRestaurants() {
  listEl.textContent = "Načítám…";
  try {
    const restaurants = await fetchRestaurants();
    renderRestaurants(restaurants);
  } catch (e) {
    listEl.textContent = "Chyba: " + (e.message || e);
  }
}

async function loadSuggestions() {
  suggestionsEl.textContent = "Načítám…";
  try {
    const items = await fetchSuggestions();
    renderSuggestions(items);
  } catch (e) {
    suggestionsEl.textContent = "Chyba: " + (e.message || e);
  }
}

async function addRestaurant() {
  const name = document.getElementById("name").value.trim();
  const url = document.getElementById("url").value.trim();
  const mode = document.getElementById("mode").value;

  if (!name || !url) {
    alert("Vyplň název i URL.");
    return;
  }

  setStatus("Ukládám…");
  const resp = await fetch("/api/restaurants", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ name, url, mode })
  });

  const data = await resp.json().catch(() => ({}));
  if (!resp.ok) {
    setStatus("Nepodařilo se uložit: " + (data.error || resp.status), false);
    return;
  }

  document.getElementById("name").value = "";
  document.getElementById("url").value = "";
  document.getElementById("mode").value = "parse";

  setStatus("Uloženo ✅ (cache se invalidovala automaticky)", true);

  // po změně seznamu restaurací je dobré smazat lokální menu cache
  clearLocalCacheOnly();

  await loadRestaurants();
}

async function deleteRestaurant(id, name) {
  if (!confirm("Opravdu smazat: " + name + "?")) return;
  setStatus("Mažu…");
  const resp = await fetch("/api/restaurants?id=" + encodeURIComponent(id), { method: "DELETE" });
  const data = await resp.json().catch(() => ({}));
  if (!resp.ok) {
    setStatus("Nepodařilo se smazat: " + (data.error || resp.status), false);
    return;
  }
  setStatus("Smazáno ✅ (cache se invalidovala automaticky)", true);

  clearLocalCacheOnly();

  await loadRestaurants();
}

async function deleteSuggestion(id, name) {
  if (!confirm("Smazat návrh: " + name + "?")) return;

  const resp = await fetch("/api/suggestions?id=" + encodeURIComponent(id), { method: "DELETE" });
  const data = await resp.json().catch(() => ({}));
  if (!resp.ok) {
    alert("Nepodařilo se smazat: " + (data.error || resp.status));
    return;
  }

  await loadSuggestions();
}

function clearLocalCacheOnly() {
  try {
    localStorage.removeItem(LS_MENU_CACHE_TODAY);
    localStorage.removeItem(LS_MENU_CACHE_ALL);
    localStorage.removeItem(LS_MENU_CACHE_DATE_TODAY);
    localStorage.removeItem(LS_MENU_CACHE_DATE_ALL);
    localStorage.removeItem(LS_RESTAURANTS_SIG);
  } catch {}
}

async function reCacheAll() {
  if (!confirm("ReCache: vyčistit lokální cache a vynutit nové cachování na serveru?")) return;

  setStatus("ReCache: čistím lokální cache…");
  clearLocalCacheOnly();

  setStatus("ReCache: žádám server o obnovu cache…");
  const resp = await fetch("/api/recache", { method: "POST" });
  const data = await resp.json().catch(() => ({}));

  if (!resp.ok) {
    setStatus("ReCache selhal: " + (data.error || resp.status), false);
    return;
  }

  setStatus("ReCache hotovo ✅ (teď jdi zpět na hlavní stránku)", true);
}

function escapeHtml(str) {
  return String(str || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;")
    .replaceAll("'", "&#039;");
}
function escapeHtmlAttr(str) { return escapeHtml(str); }

loadRestaurants();
loadSuggestions();
</script>

</body>
</html>