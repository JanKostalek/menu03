<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Menu03</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    .row { display:flex; gap:10px; flex-wrap:wrap; }
    .row input { flex: 1 1 320px; padding:10px; }
    .list-item { display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .list-left { min-width: 0; }
    .muted { color:#666; font-size: 12px; word-break: break-all; }
    .danger { background:#b00020; color:white; border:none; padding:8px 10px; cursor:pointer; }
    .danger:hover { opacity:0.9; }
    .ok { color: #0b7a0b; }
  </style>
</head>
<body>

<h2>Admin – Restaurace</h2>

<div class="buttons">
  <button onclick="goBack()">← Zpět na menu</button>
</div>

<div class="restaurant">
  <h3>Přidat restauraci</h3>
  <div class="row">
    <input type="text" id="name" placeholder="Název restaurace" />
    <input type="text" id="url" placeholder="URL menu (HTML/PDF/obrázek)" />
  </div>
  <div class="row">
    <button onclick="addRestaurant()">Uložit</button>
    <span id="status" class="muted"></span>
  </div>
</div>

<div class="restaurant">
  <h3>Seznam restaurací</h3>
  <div id="list" class="muted">Načítám…</div>
</div>

<script>
  const PASSWORD = "H3510";

  const entered = prompt("Zadej heslo:");
  if (entered !== PASSWORD) {
    alert("Špatné heslo");
    window.location.href = "/";
  }

  function goBack() {
    window.location.href = "/";
  }

  const statusEl = document.getElementById("status");
  const listEl = document.getElementById("list");

  function setStatus(msg, isOk=false) {
    statusEl.textContent = msg || "";
    statusEl.className = "muted" + (isOk ? " ok" : "");
  }

  async function fetchRestaurants() {
    const resp = await fetch("/api/restaurants");
    if (!resp.ok) throw new Error("GET /api/restaurants " + resp.status);
    return await resp.json();
  }

  function renderList(restaurants) {
    if (!restaurants || restaurants.length === 0) {
      listEl.innerHTML = "<div class='muted'>Zatím žádné restaurace.</div>";
      return;
    }

    const html = restaurants.map(r => `
      <div class="list-item">
        <div class="list-left">
          <div><b>${escapeHtml(r.name)}</b></div>
          <div class="muted">${escapeHtml(r.url)}</div>
        </div>
        <div>
          <button class="danger" onclick="deleteRestaurant('${r.id}', '${escapeHtmlAttr(r.name)}')">Smazat</button>
        </div>
      </div>
      <hr>
    `).join("");

    listEl.innerHTML = html;
  }

  async function loadList() {
    setStatus("");
    listEl.textContent = "Načítám…";
    try {
      const restaurants = await fetchRestaurants();
      renderList(restaurants);
    } catch (e) {
      listEl.innerHTML = "<div class='muted'>Nepodařilo se načíst seznam.</div>";
      setStatus("Chyba: " + (e.message || e), false);
    }
  }

  async function addRestaurant() {
    const name = document.getElementById("name").value.trim();
    const url = document.getElementById("url").value.trim();

    if (!name || !url) {
      alert("Vyplň název i URL.");
      return;
    }

    setStatus("Ukládám…");
    const resp = await fetch("/api/restaurants", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ name, url })
    });

    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) {
      setStatus("Nepodařilo se uložit: " + (data.error || resp.status), false);
      return;
    }

    document.getElementById("name").value = "";
    document.getElementById("url").value = "";

    setStatus("Uloženo ✅", true);
    await loadList(); // okamžitě refresh seznamu
  }

  async function deleteRestaurant(id, name) {
    const ok = confirm(`Opravdu smazat "${name}"?`);
    if (!ok) return;

    setStatus("Mažu…");
    const resp = await fetch("/api/restaurants?id=" + encodeURIComponent(id), {
      method: "DELETE"
    });

    const data = await resp.json().catch(() => ({}));
    if (!resp.ok) {
      setStatus("Nepodařilo se smazat: " + (data.error || resp.status), false);
      return;
    }

    setStatus("Smazáno ✅", true);
    await loadList();
  }

  // mini-escapes kvůli bezpečnému renderu
  function escapeHtml(str) {
    return String(str)
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }
  function escapeHtmlAttr(str) {
    // do confirmu stačí to samé
    return escapeHtml(str);
  }

  loadList();
</script>

</body>
</html>